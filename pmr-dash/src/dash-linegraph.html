<link rel="import"  href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/mqtt-elements/mqtt-elements.html">
<script src="https://d3js.org/d3.v4.min.js"></script>
<dom-module id="dash-linegraph">
  <template>
  <style>
  paper-card {
    width: 250px;
    margin: 5px;
  }
  .bar {
        fill: #5677fc;
    }
    #mygraph .line {
        stroke: rgb(247, 150, 29);
        stroke-width: 2;
        fill: none;
    }

    #mygraph .axis {
        shape-rendering: crispEdges;
    }

    #mygraph .x.axis line {
        stroke: rgba(88, 89, 93, .12);
    }

    #mygraph .x.axis .minor {
        stroke-opacity: .5;
    }

    #mygraph .x.axis path {
        display: none;
    }

    #mygraph .y.axis line, .y.axis path {
        fill: none;
        stroke: rgba(88, 89, 93, .5);
    }

    #mygraph .axis path,
    #mygraph .axis line {
        fill: none;
        stroke: rgba(88, 89, 93, .3);
        shape-rendering: crispEdges;
    }

    #mygraph .axis text {
        font: 10px sans-serif;
        fill: rgba(88, 89, 93, .5);
    }
  </style>
    <mqtt-connection auto url="ws://gost.geodan.nl:9001">
        <mqtt-subscription
            topic=[[topic]]
            number-of-messages="Infinity"
            last-message="{{lastMessage}}"
        ></mqtt-subscription>
    </mqtt-connection>

<paper-card class="white" heading="" alt$="{{antwoord}}">
  <div class="card-content">
      <div>Datastream: [[datastream]]</div>
      <div>Topic: [[topic]]</div>
      <svg id="mygraph"></svg>

      <!-- TODO: fancy d3 graph -->
  </div>
</paper-card>

</template>
<script>
    // register a new element called proto-element
    Polymer({
        is: "dash-linegraph",
        properties: {
            values: {
                type: Object,
                notify: true,
                observer: '_updategraph'
            },
            datastream: {
                type: Number,
                observer: '_datastreamchanged'
            },
            name : {
                type: String,
                notify: false
            },
            lastMessage : {
                type: String,
                notify: true,
                observer: '_newmessage'
            }

        },
        // add a callback to the element's prototype
        ready: function() {
            this.scopeSubtree(this.$.mygraph, true);
            this.values = [];


        },
        createElements: function () {
              var width = 500, height = 500;
              this.color = d3.scale.ordinal().range(["green", "orange", "blue", "red"]);

              this.svg = d3.select(this.$.mygraph)
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
            },
        _datastreamchanged: function(id){
            this.topic = 'Datastreams('+id+')/Observations';
        },
        _newmessage:function (msg) {
            var data = JSON.parse(msg.parsedPayload);
            this.new_value = data.result;
            this.values.push(this.new_value);

            d3.select('#mygraph').select('#line').data(this.values).enter().append();
            debug.log(this.values);
        },
        _updategraph: function(values) {

        },
        domReady: function () {
          this.createElements();
        }
    });
</script>
</dom-module>
